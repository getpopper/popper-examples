# `cloudlab-iperf`

This folder contains an example [Github 
Actions](https://github.com/features/actions) workflow that showcases how to run 
an experiment on [CloudLab](https://cloudlab.us). To execute this workflow 
locally on your computer, you can install 
[Popper](https://github.com/systemslab/popper) and 
[Docker](https://docs.docker.com/install/). Once installed, you can import the 
workflow into your project by doing:

```bash
cd myproject/
popper add popperized/popper-examples/workflows/cloudlab-iperf
```

And to run it, assuming you have an active account on CloudLab, define the 
required secrets in your environment (`secrets` attributes used in [the 
workflow](./main.workflow)), followed by:

```bash
popper run
```

## Workflow

The steps in the workflow are the following:

<p align="center">
  <img src="https://user-images.githubusercontent.com/473117/57112776-61330900-6cf6-11e9-8260-7259ef19c324.png">
</p>

> Diagram above obtained with:
>
> ```bash
>  popper dot --wfile workflows/cloudlab-iperf/main.workflow | dot -Tpng -o wf.png
> ```

You can also see the contents of the [`.workflow` file](./main.workflow). 
High-level description of the steps in the workflow:

 1. `"build context"`. Uses the [GENI `build-context` 
    action](https://github.com/popperized/geni/tree/master/build-context) to 
    create a geni-lib context that is used by subsequent GENI-based actions.
 2. `"request resources"`. Uses the [GENI `exec` 
    action](https://github.com/popperized/geni/tree/master/exec) to allocate two 
    nodes on a CloudLab site. This action also creates an Ansible inventory used 
    in the next step.
 3. `"run test"`. Executes an [Ansible 
    action](https://github.com/popperized/ansible) that launches an [`iperf` 
    Docker 
    container](http://networkstatic.net/measuring-network-bandwidth-using-iperf-and-docker/) 
    on each allocated node, executes an iperf test, and retrieves output files.
 4. `"teardown"`. Releases the CloudLab resources used for the test (using the 
    [GENI `exec` action](https://github.com/popperized/geni/tree/master/exec) 
    again).
 5. `"plot results"`. Plots results of the test using a 
    [Gnuplot](http://www.gnuplot.info/) Docker image.

The input scripts for each of the actions executed in the workflow are contained 
in the `geni`, `ansible`, and `gnuplot` subfolders. After a successful 
execution, the entire folder looks like the following:

```
$ tree -aI .git workflows/cloudlab-iperf/
workflows/cloudlab-iperf/
├── README.md
├── ansible
│   └── playbook.yml
├── geni
│   ├── hosts          <<<<<
│   ├── manifest.xml   <<<<<
│   ├── release.py
│   └── request.py
├── gnuplot
│   ├── graph-tcp-data.p
│   └── plot.sh
├── main.workflow
└── results            <<<<<
    ├── bandwidth.pdf  <<<<<
    ├── iperf.dat      <<<<<
    ├── iperf.out      <<<<<
    ├── retries.pdf    <<<<<
    └── transfer.pdf   <<<<<
```

Lines marked with `<<<<` denote output files generated by the execution of the 
workflow.

Visit <https://github.com/systemslab/popper> to learn more about Popper.
