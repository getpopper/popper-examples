# `cloudlab-iperf`

A workflow for running an end-to-end iperf test on CloudLab using 
`geni-lib` and Ansible. It assumes basic knowledge of how these two 
tools work. The workflow in [`wf.yml`](./wf.yml) runs an iperf on a 
[Cloudlab][cloudlab] allocation using Ansible. The workflow consists 
of the following steps:

  * **`allocate resources`**. Request for resources to CloudLab and 
    wait for them to be instantiated. The configuration is specified 
    in the [`geni/config.py`](./geni/config.py)

  * **`generate ansible inventory`**. Generates an Ansible inventory 
    out of the GENI manifest produced by the previous `allocate 
    resources` step. This is used by the subsequent `run test` step.

  * **`run test`**. Runs the [Ansible 
    playbook](./ansible/playbook.yml) that executes three high-level 
    tasks: launch an [iperf Docker container][iperf] on each allocated 
    node, executes an iperf test, and retrieves output files.

  * **`release resources`**. Releases the CloudLab resources used for 
    the test.

  * **`plot results`**. Plots results of the test using a 
    [Gnuplot](http://www.gnuplot.info) Docker image.

## Usage

To execute this workflow:

 1. Clone this repository or copy the contents of this folder into 
    your project:

    ```bash
    git clone https://github.com/getpopper/popper-examples

    cd workflows/cloudlab-iperf
    ```

 2. Define the secrets expected by the workflow, declared in the 
    `secrets` attribute of steps:

    ```bash
    export GENI_FRAMEWORK=emulab-ch2
    export GENI_PROJECT=<project>
    export GENI_USERNAME=<username>
    export GENI_KEY_PASSPHRASE='<password>'
    export GENI_PUBKEY_DATA=$(cat ~/.ssh/id_rsa.pub | base64)
    export GENI_CERT_DATA=$(cat ~/.ssh/cloudlab.pem | base64)

    export ANSIBLE_SSH_KEY_DATA=$(cat ~/.ssh/id_rsa | base64)
    ```

    See [the GENI image's README][gd] for more information about the 
    secrets related to the GENI steps; similarly [see here][cad] for 
    the Ansible step.

 3. Tweak the following to your needs:

     * The experiment name in the [GENI config 
       file](./geni/config.py). Changing the name of the experiment 
       avoids having another member of your project running the script 
       and resulting in name clashes.

     * Specify in the `deploy` step which Ansible playbook is to be 
       executed (see the [`ansible/playbooks/`](./ansible/playbooks) 
       folder. Multiple playbooks may exist, depending on what type of 
       deployment is needed (e.g. ).

 4. Execute the workflow by doing:

    ```bash
    popper run -f wf.yml
    ```

The inputs for each step are contained in the `geni/`, `ansible/`, and 
`gnuplot/` subfolders. After a successful execution, the entire folder 
looks like the following:

```
$ tree -aI .git workflows/cloudlab-iperf/
workflows/cloudlab-iperf/
├── README.md
├── ansible
│   ├── hosts.yaml     <<<<<
│   └── playbook.yml
├── geni
│   ├── config.py
│   └── manifest.xml   <<<<<
├── gnuplot
│   ├── graph-tcp-data.p
│   └── plot.sh
├── main.workflow
└── results            <<<<<
    ├── bandwidth.pdf  <<<<<
    ├── iperf.dat      <<<<<
    ├── iperf.out      <<<<<
    ├── retries.pdf    <<<<<
    └── transfer.pdf   <<<<<
```

Lines marked with `<<<<` denote output files generated by the 
execution of the workflow.

For more information on Popper, visit <https://github.com/getpopper/popper>.

[cloudlab]: https://cloudlab.us
[gd]: https://github.com/popperized/library/tree/master/geni
[cad]: https://github.com/popperized/library/tree/master/ansible
[iperf]: http://networkstatic.net/measuring-network-bandwidth-using-iperf-and-docker

